<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Vendedor</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
        }

        #sidebar {
            width: 250px;
            height: 100vh;
            transition: width 0.3s;
            background-color: #f8f9fa;
            /* Color de fondo del sidebar */
            border-right: 1px solid #dee2e6;
            /* Borde derecho */
        }

        #sidebar.collapsed {
            width: 80px;
        }

        #sidebar .list-group-item {
            display: flex;
            align-items: center;
            white-space: nowrap;
            overflow: hidden;
            transition: all 0.3s;
        }

        #sidebar.collapsed .list-group-item span {
            display: none;
        }

        #sidebar .list-group-item i {
            font-size: 20px;
        }

        #mainContent {
            height: 100vh;
            /* Altura completa para el contenido principal */
            transition: margin-left 0.3s;
            padding: 20px;
            overflow-y: auto;
            /* Permite el scroll solo en el contenido */
            background-color: #ffffff;
            /* Color de fondo del contenido */
        }

        .tooltip-custom {
            position: absolute;
            background-color: #333;
            color: #fff;
            padding: 5px;
            border-radius: 5px;
            font-size: 12px;
            display: none;
            z-index: 1000;
        }
    </style>
</head>

<body>
    <!-- Botón para abrir/cerrar el sidebar -->
    <button class="btn btn-primary m-3" id="toggleButton">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Sidebar Lateral -->
    <div class="d-flex" style="height: 100vh;">
        <div id="sidebar">
            <ul class="list-group list-group-flush position-relative">
                <li class="list-group-item" data-tooltip="Registro de inmuebles" id="registerBtn">
                    <i class="fas fa-edit"></i> <span>Registro de inmuebles</span>
                </li>
                <li class="list-group-item" data-tooltip="Lista de inmuebles" id="listBtn">
                    <i class="fas fa-list"></i> <span>Lista de inmuebles</span>
                </li>
                <li class="list-group-item" data-tooltip="Inmuebles vendidos" id="soldBtn">
                    <i class="fas fa-check"></i> <span>Inmuebles vendidos</span>
                </li>
                <li class="list-group-item mt-auto" data-tooltip="Cerrar Sesión" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> <span>Cerrar Sesión</span>
                </li>
            </ul>
        </div>

        <!-- Contenido principal -->
        <div id="mainContent" class="flex-grow-1">
            <h1>Bienvenido a la gestión de Vendedores</h1>
            <p>Aquí puede registrar, listar y gestionar inmuebles.</p>
            <div id="contentArea"></div> <!-- Área para cargar contenido dinámico -->
        </div>
    </div>

    <!-- Tooltip personalizado -->
    <div id="tooltip" class="tooltip-custom"></div>




    <!-- JavaScript para abrir/cerrar el sidebar y manejar el contenido -->
    <script>

        // Función para obtener el valor de una cookie
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        // Verificar si el token existe en las cookies
        const token = getCookie('token');  // Suponiendo que el token se llama 'authToken'

        // Si no hay token, redirigir a la página de login
        if (!token) {
            window.location.href = '/';  // Cambia '/login' por la URL de tu página de login
        }

        document.getElementById("logoutBtn").addEventListener("click", function () {
            // Eliminar las cookies
            document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/"; // Cambia 'authToken' si es necesario
            document.cookie = "userId=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/"; // Cambia 'userId' si es necesario

            // Redirigir al usuario a la página de login
            window.location.href = '/'; // Cambia '/login' por la URL de tu página de login
        });

        const sidebar = document.getElementById("sidebar");
        const toggleButton = document.getElementById("toggleButton");
        const mainContent = document.getElementById("mainContent");
        const tooltip = document.getElementById("tooltip");
        const contentArea = document.getElementById("contentArea");

        toggleButton.addEventListener("click", function () {
            sidebar.classList.toggle("collapsed");
            if (sidebar.classList.contains("collapsed")) {
                mainContent.style.marginLeft = "80px";
                toggleButton.innerHTML = '<i class="fas fa-arrow-right"></i>';  // Cambia icono al cerrar
            } else {
                mainContent.style.marginLeft = "250px";
                toggleButton.innerHTML = '<i class="fas fa-bars"></i>';  // Cambia icono al abrir
            }
        });

        document.getElementById("registerBtn").addEventListener("click", function () {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
        <h2>Registro de Inmuebles</h2>
        <form id="propertyForm">
            <!-- El formulario aquí permanece igual -->
            <div class="mb-3">
                <label for="propertyTitle" class="form-label">Título del Inmueble</label>
                <input type="text" class="form-control" id="propertyTitle" placeholder="Ej. Casa en Lima" required>
            </div>
            <div class="mb-3">
                <label for="propertyDescription" class="form-label">Descripción</label>
                <textarea class="form-control" id="propertyDescription" rows="3" placeholder="Describe el inmueble" required></textarea>
            </div>
            <div class="mb-3">
                <label for="propertyPrice" class="form-label">Precio</label>
                <input type="number" class="form-control" id="propertyPrice" placeholder="Precio en dólares" required>
            </div>
            <div class="mb-3">
                <label for="propertySize" class="form-label">Tamaño (m²)</label>
                <input type="number" class="form-control" id="propertySize" placeholder="Tamaño en metros cuadrados" required>
            </div>
            <div class="mb-3">
                <label for="propertyImages" class="form-label">Imágenes del Inmueble</label>
                <input type="text" class="form-control" id="propertyImages" placeholder="URL de las imágenes, separadas por comas">
            </div>
            <h4>Dirección</h4>
            <div class="mb-3">
                <label for="propertyStreet" class="form-label">Calle</label>
                <input type="text" class="form-control" id="propertyStreet" placeholder="Calle" required>
            </div>
            <div class="mb-3">
                <label for="propertyCity" class="form-label">Ciudad</label>
                <input type="text" class="form-control" id="propertyCity" placeholder="Ciudad" required>
            </div>
            <div class="mb-3">
                <label for="propertyState" class="form-label">Estado/Provincia</label>
                <input type="text" class="form-control" id="propertyState" placeholder="Estado/Provincia" required>
            </div>
            <div class="mb-3">
                <label for="propertyPostalCode" class="form-label">Código Postal</label>
                <input type="text" class="form-control" id="propertyPostalCode" placeholder="Código Postal" required>
            </div>
            <div class="mb-3">
                <label for="propertyCountry" class="form-label">País</label>
                <input type="text" class="form-control" id="propertyCountry" placeholder="País" required>
            </div>
            <div class="mb-3">
                <label for="isForSale" class="form-label">¿Está en venta?</label>
                <select class="form-select" id="isForSale" required>
                    <option value="true" selected>En venta</option>
                    <option value="false">No en venta</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Registrar Inmueble</button>
        </form>
    `;

            // Manejar el envío del formulario
            document.getElementById('propertyForm').addEventListener('submit', async function (event) {
                event.preventDefault();

                // Obtener el id del usuario desde las cookies
                const ownerId = getCookie('userId'); // Asumimos que la cookie se llama 'iduser'

                if (!ownerId) {
                    alert('No se encontró el ID del usuario en las cookies');
                    return;
                }

                // Recopilar los datos del formulario
                const propertyData = {
                    title: document.getElementById('propertyTitle').value,
                    description: document.getElementById('propertyDescription').value,
                    price: parseFloat(document.getElementById('propertyPrice').value), // Asegurarse de que sea un número
                    size: parseFloat(document.getElementById('propertySize').value),   // Asegurarse de que sea un número
                    images: document.getElementById('propertyImages').value.split(',').map(img => img.trim()), // Convertir a array y limpiar espacios
                    address: {
                        street: document.getElementById('propertyStreet').value,
                        city: document.getElementById('propertyCity').value,
                        state: document.getElementById('propertyState').value,
                        postalCode: document.getElementById('propertyPostalCode').value,
                        country: document.getElementById('propertyCountry').value
                    },
                    isForSale: document.getElementById('isForSale').value === 'true',
                    owner: ownerId // Aquí se agrega el ID del usuario como propietario
                };

                console.log(propertyData);

                // Hacer la petición POST para registrar el inmueble
                try {
                    const response = await fetch('http://localhost:3000/api/v1/property', {  // Cambia a tu ruta de API
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(propertyData)
                    });

                    const result = await response.json();
                    if (response.ok) {
                        alert('Inmueble registrado con éxito');
                        // Puedes redirigir a otra página o limpiar el formulario
                    } else {
                        alert('Error al registrar el inmueble: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Hubo un error al registrar el inmueble');
                }
            });
        });

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }



        document.getElementById("listBtn").addEventListener("click", async function () {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
        <h2>Lista de Inmuebles</h2>
        <p>Aquí se mostrarán todos los inmuebles registrados.</p>
        <div class="row" id="propertyList"></div>
    `;

            // Obtener el userId de las cookies
            const userId = getCookie('userId');
            if (!userId) {
                alert('Usuario no autenticado');
                return;
            }

            // Obtener la lista de inmuebles desde la API
            try {
                const response = await fetch(`http://localhost:3000/api/v1/property`); // Cambia a tu ruta de API
                const properties = await response.json();

                // Filtrar inmuebles que pertenecen al usuario
                const userProperties = properties.filter(property => property.owner === userId);

                // Verificar si hay inmuebles del usuario
                if (userProperties.length === 0) {
                    document.getElementById('propertyList').innerHTML = `<p>No hay inmuebles registrados para este usuario.</p>`;
                    return;
                }

                // Cargar los inmuebles en tarjetas
                const propertyList = document.getElementById('propertyList');
                userProperties.forEach(property => {
                    propertyList.innerHTML += `
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <div id="carousel-${property._id}" class="carousel slide" data-bs-ride="carousel">
                            <div class="carousel-inner">
                                ${property.images.map((img, index) => `
                                    <div class="carousel-item ${index === 0 ? 'active' : ''}">
                                        <img src="${img}" class="d-block w-100" alt="Imagen del inmueble">
                                    </div>
                                `).join('')}
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#carousel-${property._id}" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#carousel-${property._id}" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                        <div class="card-body">
                         <button class="btn ${property.isForSale ? 'btn-warning' : 'btn-success'}">${property.isForSale ? 'En Venta' : 'Vendido'}</button>

                            <h5 class="card-title">${property.title}</h5>
                            <p class="card-text">${property.description}</p>
                            <p class="card-text"><strong>Precio:</strong> $${property.price}</p>
                            <p class="card-text"><strong>Tamaño:</strong> ${property.size} m²</p>
                            <button class="btn btn-danger" onclick="deleteProperty('${property._id}')">Eliminar</button>
                        </div>
                    </div>
                </div>
            `;
                });
            } catch (error) {
                console.error('Error al cargar los inmuebles:', error);
                alert('Hubo un error al cargar los inmuebles');
            }
        });

        // Función para eliminar un inmueble
        async function deleteProperty(id) {
            if (confirm('¿Estás seguro de que deseas eliminar este inmueble?')) {
                try {
                    const response = await fetch(`http://localhost:3000/api/v1/property/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        alert('Inmueble eliminado con éxito');
                        document.getElementById("listBtn").click(); // Recargar la lista
                    } else {
                        alert('Error al eliminar el inmueble');
                    }
                } catch (error) {
                    console.error('Error al eliminar el inmueble:', error);
                    alert('Hubo un error al eliminar el inmueble');
                }
            }
        }


        // Cargar los inmuebles vendidos
        document.getElementById("soldBtn").addEventListener("click", async function () {
            const contentArea = document.getElementById('contentArea');
            contentArea.innerHTML = `
        <h2>Inmuebles Vendidos</h2>
        <p>Aquí se mostrarán todos los inmuebles vendidos.</p>
        <table class="table">
            <thead>
                <tr>
                    <th>Título</th>
                    <th>Precio</th>
                    <th>Fecha de Venta</th>
                </tr>
            </thead>
            <tbody id="soldPropertyList">
                <tr>
                    <td>Cargando...</td>
                    <td></td>
                    <td></td>
                </tr>
            </tbody>
        </table>
    `;

            // Obtener la lista de inmuebles desde la API
            try {
                const response = await fetch(`http://localhost:3000/api/v1/property`); // Cambia a tu ruta de API
                const properties = await response.json();

                // Filtrar inmuebles vendidos (isForSale === false)
                const soldProperties = properties.filter(property => property.isForSale === false);

                // Verificar si hay inmuebles vendidos
                const soldPropertyList = document.getElementById('soldPropertyList');
                if (soldProperties.length === 0) {
                    soldPropertyList.innerHTML = `<tr><td colspan="3">No hay inmuebles vendidos.</td></tr>`;
                    return;
                }

                // Cargar los inmuebles vendidos en la tabla
                soldPropertyList.innerHTML = ''; // Limpiar contenido anterior
                soldProperties.forEach(property => {
                    soldPropertyList.innerHTML += `
                <tr>
                    <td>${property.title}</td>
                    <td>$${property.price}</td>
                    <td>${new Date(property.createdAt).toLocaleDateString()}</td> <!-- Asegúrate de que soldDate esté en el formato correcto -->
                </tr>
            `;
                });
            } catch (error) {
                console.error('Error al cargar los inmuebles vendidos:', error);
                alert('Hubo un error al cargar los inmuebles vendidos');
            }
        });


        // Añadir tooltip para cada elemento del sidebar
        const items = document.querySelectorAll('#sidebar .list-group-item');
        items.forEach(item => {
            item.addEventListener('mouseenter', (e) => {
                const tooltipText = e.currentTarget.getAttribute('data-tooltip');
                tooltip.style.display = 'block';
                tooltip.innerText = tooltipText;
                const rect = e.currentTarget.getBoundingClientRect();
                tooltip.style.top = `${rect.top + window.scrollY}px`;
                tooltip.style.left = `${rect.right + 5}px`; // Desplazar un poco a la derecha
            });
            item.addEventListener('mouseleave', () => {
                tooltip.style.display = 'none';
            });
        });
    </script>
</body>

</html>